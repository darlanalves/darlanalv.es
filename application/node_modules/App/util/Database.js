var Class = require('jn-classjs');
var mysql = require('mysql');

var url = process.env.CLEARDB_DATABASE_URL;
var $connection = null;

function createConnection() {
	var connection = mysql.createConnection(url);
	handleDisconnect(connection);
	connection.connect(callback);
	return connection;
}

function handleDisconnect(connection) {
	connection.on('error', function(err) {
		if (!err.fatal) {
			return;
		}

		if (err.code !== 'PROTOCOL_CONNECTION_LOST') {
			throw err;
		}

		console.log('MySQL connection lost, reconnecting: ' + err.stack);
		createConnection();
	});
}

var Database = Class.define('App.util.Database', {
	connect: function(callback) {
		if (null === $connection) {
			$connection = createConnection(callback);
		} else {
			callback();
		}
	}
});

module.exports = Database;